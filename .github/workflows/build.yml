# GitHub Actions workflow for building GMT World Time Watchface
# Builds for multiple Garmin Connect IQ devices with headless screenshot capture

name: Build Garmin Watchface

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:  # Allow manual trigger

# Sets permissions for GitHub Pages deployment
permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  # Build Docker image once and push to GHCR
  build-docker-image:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/garmin-watchface/builder
          tags: |
            type=sha
            type=ref,event=branch
            type=ref,event=pr
            type=raw,value=latest,enable={{is_default_branch}}
          flavor: |
            latest=false

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            GARMIN_EMAIL=${{ secrets.GARMIN_EMAIL }}
            GARMIN_PASSWORD=${{ secrets.GARMIN_PASSWORD }}

  # Generate device matrix from centralized devices.txt
  generate-matrix:
    runs-on: ubuntu-latest
    outputs:
      devices: ${{ steps.set-matrix.outputs.devices }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate device matrix from devices.txt
        id: set-matrix
        run: |
          # Read devices.txt, filter out comments and empty lines, convert to JSON array
          DEVICES=$(grep -v '^#' devices.txt | grep -v '^[[:space:]]*$' | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "devices=$DEVICES" >> $GITHUB_OUTPUT
          echo "Building for devices: $DEVICES"

  # Build watch faces for all devices using the shared Docker image
  build:
    needs: [build-docker-image, generate-matrix]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read

    strategy:
      matrix:
        device: ${{ fromJson(needs.generate-matrix.outputs.devices) }}
      fail-fast: false  # Continue building other devices if one fails

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull Docker image
        run: |
          # Use short SHA (7 chars) to match metadata action format
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          IMAGE_TAG="ghcr.io/${{ github.repository_owner }}/garmin-watchface/builder:sha-${SHORT_SHA}"
          echo "Pulling image: $IMAGE_TAG"
          docker pull "$IMAGE_TAG"

      - name: Build and Screenshot for ${{ matrix.device }}
        run: |
          # Create output directories
          mkdir -p bin screenshots

          # Run build inside Docker container using the shared image from GHCR
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          IMAGE_TAG="ghcr.io/${{ github.repository_owner }}/garmin-watchface/builder:sha-${SHORT_SHA}"
          docker run --rm \
            -v "$(pwd):/workspace" \
            -e DEVICE="${{ matrix.device }}" \
            "$IMAGE_TAG" \
            /workspace/scripts/build-in-docker.sh

          # Verify build output
          if [ -f "bin/GMTWorldTime-${{ matrix.device }}.prg" ]; then
            echo "âœ… Build successful for ${{ matrix.device }}"
            ls -la bin/
          else
            echo "âŒ Build failed for ${{ matrix.device }}"
            exit 1
          fi

          # Check screenshot
          if [ -f "screenshots/${{ matrix.device }}.png" ]; then
            echo "âœ… Screenshot captured for ${{ matrix.device }}"
          else
            echo "âš ï¸ Screenshot not captured for ${{ matrix.device }}"
          fi

      - name: Add Build Status to Summary
        if: always()
        run: |
          echo "### ${{ matrix.device }}" >> $GITHUB_STEP_SUMMARY
          if [ -f "bin/GMTWorldTime-${{ matrix.device }}.prg" ]; then
            PRG_SIZE=$(ls -lh "bin/GMTWorldTime-${{ matrix.device }}.prg" | awk '{print $5}')
            echo "âœ… Build successful - $PRG_SIZE" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Build failed" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -f "screenshots/${{ matrix.device }}.png" ]; then
            echo "ðŸ“¸ Screenshot captured" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No screenshot" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload PRG Artifact
        uses: actions/upload-artifact@v4
        with:
          name: GMTWorldTime-${{ matrix.device }}
          path: bin/GMTWorldTime-${{ matrix.device }}.prg
          retention-days: 30

      - name: Upload IQ Package Artifact
        uses: actions/upload-artifact@v4
        with:
          name: GMTWorldTime-${{ matrix.device }}-iq
          path: bin/GMTWorldTime-${{ matrix.device }}.iq
          retention-days: 90
          if-no-files-found: ignore

      - name: Upload Screenshot
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: screenshot-${{ matrix.device }}
          path: screenshots/${{ matrix.device }}.png
          retention-days: 30
          if-no-files-found: ignore

  # Combine all builds into a single artifact
  combine-artifacts:
    needs: build
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Download all PRG artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-builds/
          pattern: GMTWorldTime-*
          merge-multiple: true

      - name: Download all IQ packages
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          path: all-iq-packages/
          pattern: GMTWorldTime-*-iq
          merge-multiple: true

      - name: Download all screenshots
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          path: all-screenshots/
          pattern: screenshot-*
          merge-multiple: true

      - name: Create combined builds artifact
        uses: actions/upload-artifact@v4
        with:
          name: GMTWorldTime-all-devices
          path: all-builds/
          retention-days: 90

      - name: Create combined IQ packages artifact
        uses: actions/upload-artifact@v4
        continue-on-error: true
        with:
          name: GMTWorldTime-all-iq-packages
          path: all-iq-packages/
          retention-days: 90
          if-no-files-found: ignore

      - name: Create combined screenshots artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: all-screenshots
          path: all-screenshots/
          retention-days: 90
          if-no-files-found: ignore

      - name: Generate Build Summary
        run: |
          echo "# ðŸ“± GMT World Time - Build Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Device | Build Status | Screenshot |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------------|------------|" >> $GITHUB_STEP_SUMMARY

          # Create a comprehensive summary
          DEVICES=(fenix7 fenix5 venu venu2 venu2s venu3 venu441mm venu445mm venux1 venusq2 fr965 fr255 fr245 vivoactive5 vivoactive4 epix2)

          for device in "${DEVICES[@]}"; do
            # Check for PRG file
            prg_file="all-builds/GMTWorldTime-${device}.prg"
            if [ -f "$prg_file" ]; then
              size=$(ls -lh "$prg_file" | awk '{print $5}')
              build_status="âœ… $size"
            else
              build_status="âŒ Failed"
            fi

            # Check for screenshot
            screenshot_file="all-screenshots/${device}.png"
            if [ -f "$screenshot_file" ]; then
              screenshot_status="ðŸ“¸ Captured"
            else
              screenshot_status="âš ï¸ Missing"
            fi

            echo "| $device | $build_status | $screenshot_status |" >> $GITHUB_STEP_SUMMARY
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Download Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- **All PRG Files** (for testing): \`GMTWorldTime-all-devices\` artifact" >> $GITHUB_STEP_SUMMARY
          echo "- **All IQ Packages** (for store submission): \`GMTWorldTime-all-iq-packages\` artifact" >> $GITHUB_STEP_SUMMARY
          echo "- **All Screenshots**: \`all-screenshots\` artifact" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Report**: \`build-report\` artifact (HTML with embedded screenshots)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŒ View Screenshots" >> $GITHUB_STEP_SUMMARY
          echo "Download the \`build-report\` artifact and open \`index.html\` to view all screenshots in a beautiful gallery, or wait for the GitHub Pages deployment to complete." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¤ Store Submission" >> $GITHUB_STEP_SUMMARY
          echo "The \`.iq\` files in the \`GMTWorldTime-all-iq-packages\` artifact are ready for submission to the Garmin Connect IQ Store." >> $GITHUB_STEP_SUMMARY

  # Generate HTML build report with screenshots
  generate-report:
    needs: combine-artifacts
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all builds
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          path: all-builds/
          pattern: GMTWorldTime-*
          merge-multiple: true

      - name: Download all screenshots
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          path: all-screenshots/
          pattern: screenshot-*
          merge-multiple: true

      - name: Generate HTML Build Report
        run: |
          mkdir -p build-report
          
          # Get timestamp
          TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
          
          # Count devices
          TOTAL_DEVICES=0
          PASSED_DEVICES=0
          FAILED_DEVICES=0
          
          if [ -d "all-builds" ]; then
            TOTAL_DEVICES=$(find all-builds -name "*.prg" | wc -l)
            PASSED_DEVICES=$TOTAL_DEVICES
          fi
          
          # Start HTML
          cat > build-report/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <title>GMT World Time - Build Report</title>
              <style>
                  * { box-sizing: border-box; }
                  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 40px; background: #0a0a0a; color: #fff; }
                  h1 { color: #fff; font-weight: 300; margin-bottom: 10px; }
                  .timestamp { color: #666; margin-bottom: 30px; }
                  .summary { display: flex; gap: 30px; margin-bottom: 40px; }
                  .stat { background: #1a1a1a; padding: 20px 30px; border-radius: 12px; text-align: center; }
                  .stat-value { font-size: 42px; font-weight: 700; }
                  .stat-label { color: #888; font-size: 14px; margin-top: 5px; }
                  .pass { color: #4ade80; }
                  .fail { color: #f87171; }
                  .device-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
                  .device-card { background: #1a1a1a; border-radius: 12px; overflow: hidden; }
                  .device-header { padding: 15px 20px; border-bottom: 1px solid #333; }
                  .device-name { font-weight: 600; font-size: 15px; }
                  .device-info { color: #666; font-size: 11px; margin-top: 4px; }
                  .device-screenshot { width: 100%; aspect-ratio: 1; object-fit: contain; background: #000; }
                  .no-screenshot { width: 100%; aspect-ratio: 1; display: flex; align-items: center; justify-content: center; background: #0a0a0a; color: #444; font-size: 14px; }
                  .device-status { padding: 12px 20px; font-size: 12px; font-weight: 500; }
                  .status-pass { background: #052e16; color: #4ade80; }
                  .status-fail { background: #450a0a; color: #f87171; }
              </style>
          </head>
          <body>
              <h1>GMT World Time Watchface</h1>
              <p class="timestamp">Build Report - TIMESTAMP_PLACEHOLDER</p>
              
              <div class="summary">
                  <div class="stat">
                      <div class="stat-value">TOTAL_PLACEHOLDER</div>
                      <div class="stat-label">Devices Tested</div>
                  </div>
                  <div class="stat">
                      <div class="stat-value pass">PASSED_PLACEHOLDER</div>
                      <div class="stat-label">Build Passed</div>
                  </div>
                  <div class="stat">
                      <div class="stat-value fail">FAILED_PLACEHOLDER</div>
                      <div class="stat-label">Build Failed</div>
                  </div>
              </div>
              
              <div class="device-grid">
          EOF
          
          # Add device cards
          for prg in all-builds/*.prg; do
            if [ -f "$prg" ]; then
              device=$(basename "$prg" .prg | sed 's/GMTWorldTime-//')
              device_name=$(echo "$device" | sed 's/\([a-z]\)\([0-9]\)/\1 \2/g' | sed 's/\([a-z]\)\([A-Z]\)/\1 \2/g' | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) tolower(substr($i,2))} 1')
              prg_size=$(ls -lh "$prg" | awk '{print $5}')
              screenshot_file="all-screenshots/${device}.png"
              
              cat >> build-report/index.html << CARD
                  <div class="device-card">
                      <div class="device-header">
                          <div class="device-name">$device_name</div>
                          <div class="device-info">$device - $prg_size</div>
                      </div>
          CARD
              
              if [ -f "$screenshot_file" ]; then
                cp "$screenshot_file" "build-report/${device}.png"
                cat >> build-report/index.html << CARD
                      <img class='device-screenshot' src='${device}.png' alt='$device_name'>
          CARD
              else
                cat >> build-report/index.html << CARD
                      <div class='no-screenshot'>No screenshot available</div>
          CARD
              fi
              
              cat >> build-report/index.html << CARD
                      <div class="device-status status-pass">âœ… Build Passed</div>
                  </div>
          CARD
            fi
          done
          
          # Close HTML
          cat >> build-report/index.html << 'EOF'
              </div>
          </body>
          </html>
          EOF
          
          # Replace placeholders
          sed -i "s/TIMESTAMP_PLACEHOLDER/$TIMESTAMP/g" build-report/index.html
          sed -i "s/TOTAL_PLACEHOLDER/$TOTAL_DEVICES/g" build-report/index.html
          sed -i "s/PASSED_PLACEHOLDER/$PASSED_DEVICES/g" build-report/index.html
          sed -i "s/FAILED_PLACEHOLDER/$FAILED_DEVICES/g" build-report/index.html
          
          echo "âœ… Build report generated with $TOTAL_DEVICES devices"
          ls -la build-report/

      - name: Upload Build Report
        uses: actions/upload-artifact@v4
        with:
          name: build-report
          path: build-report/
          retention-days: 90

      - name: Add Report Summary
        run: |
          echo "# ðŸ“Š Build Report Generated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "A comprehensive HTML build report has been generated with all device screenshots." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ View Report" >> $GITHUB_STEP_SUMMARY
          echo "1. Download the \`build-report\` artifact from this workflow run" >> $GITHUB_STEP_SUMMARY
          echo "2. Extract and open \`index.html\` in your browser" >> $GITHUB_STEP_SUMMARY
          echo "3. Or wait for GitHub Pages deployment (main branch only)" >> $GITHUB_STEP_SUMMARY

  # Deploy build report to GitHub Pages
  deploy-pages:
    needs: generate-report
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
    
    steps:
      - name: Download build report
        uses: actions/download-artifact@v4
        with:
          name: build-report
          path: ./public

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./public

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Add Pages Deployment Summary
        run: |
          echo "# ðŸš€ Screenshots Deployed to GitHub Pages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŒ View Live Build Report" >> $GITHUB_STEP_SUMMARY
          echo "Your build report with all device screenshots is now live at:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**${{ steps.deployment.outputs.page_url }}**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The report includes:" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¸ Screenshots for all devices" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“Š Build statistics" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¦ File sizes for each device" >> $GITHUB_STEP_SUMMARY

  # Create a release on tags
  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all PRG artifacts
        uses: actions/download-artifact@v4
        with:
          path: builds/
          pattern: GMTWorldTime-*
          merge-multiple: true

      - name: Download all IQ packages
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          path: iq-packages/
          pattern: GMTWorldTime-*-iq
          merge-multiple: true

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            builds/*.prg
            iq-packages/*.iq
          generate_release_notes: true
          body: |
            ## ðŸ“¦ Downloads

            ### For Testing
            - Download `.prg` files to test on your device or simulator

            ### For Store Submission
            - Download `.iq` files to submit to the Garmin Connect IQ Store

            See the [Build Report](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for screenshots of all devices.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
