# GitHub Actions workflow for building GMT World Time Watchface
# Builds for multiple Garmin Connect IQ devices with headless screenshot capture

name: Build Garmin Watchface

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  build:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        device: 
          - fenix7
          - fenix5
          - venu
          - venu2
          - venu3
          - venu441mm
          - venu445mm
          - venux1
          - venusq2
          - fr965
          - fr255
          - fr245
          - vivoactive5
          - vivoactive4
          - epix2
      fail-fast: false  # Continue building other devices if one fails
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Cache Connect IQ SDK
        id: cache-sdk
        uses: actions/cache@v4
        with:
          path: |
            ~/.Garmin/ConnectIQ
          key: connectiq-sdk-7.3.1-${{ runner.os }}

      - name: Download and Setup Connect IQ SDK
        run: |
          # Create directories
          mkdir -p ~/.Garmin/ConnectIQ/Sdks
          mkdir -p ~/.Garmin/ConnectIQ/Devices
          
          # Download SDK bundle from our GitHub release
          SDK_URL="https://github.com/berryk/Garmin-watchface/releases/download/sdk-v8.4.0/connectiq-sdk-bundle.zip"
          
          echo "Downloading Connect IQ SDK bundle..."
          wget -q "$SDK_URL" -O /tmp/sdk.zip
          
          echo "Extracting SDK..."
          unzip -q /tmp/sdk.zip -d ~/.Garmin/ConnectIQ/Sdks/sdk
          rm /tmp/sdk.zip
          
          # Move device files to correct location
          if [ -d ~/.Garmin/ConnectIQ/Sdks/sdk/Devices ]; then
            mv ~/.Garmin/ConnectIQ/Sdks/sdk/Devices/* ~/.Garmin/ConnectIQ/Devices/ 2>/dev/null || true
          fi
          
          # Set SDK path
          echo "CONNECTIQ_SDK=$HOME/.Garmin/ConnectIQ/Sdks/sdk" >> $GITHUB_ENV
          
          # Make scripts executable
          chmod +x ~/.Garmin/ConnectIQ/Sdks/sdk/bin/* 2>/dev/null || true
          
          echo "SDK installed to: $HOME/.Garmin/ConnectIQ/Sdks/sdk"
          ls -la ~/.Garmin/ConnectIQ/Sdks/sdk/bin/ || echo "bin directory not found"
          ls -la ~/.Garmin/ConnectIQ/Devices/ || echo "No devices found"

      - name: Generate Developer Key
        run: |
          # Generate a developer key for building (CI-only, not for distribution)
          openssl genrsa -out developer_key.pem 4096
          # Convert to DER format
          openssl pkcs8 -topk8 -inform PEM -outform DER -in developer_key.pem -out developer_key.der -nocrypt
          echo "Developer key generated"

      - name: Build for ${{ matrix.device }}
        run: |
          mkdir -p bin
          
          # Use the SDK we downloaded
          SDK_PATH="$HOME/.Garmin/ConnectIQ/Sdks/sdk"
          
          echo "Building for device: ${{ matrix.device }}"
          echo "SDK Path: $SDK_PATH"
          
          # Find monkeybrains.jar
          MONKEYBRAINS=$(find $SDK_PATH -name "monkeybrains.jar" | head -1)
          
          if [ -z "$MONKEYBRAINS" ]; then
            echo "ERROR: monkeybrains.jar not found in SDK"
            ls -la $SDK_PATH/
            exit 1
          fi
          
          echo "Using monkeybrains.jar: $MONKEYBRAINS"
          
          # Build the watchface
          java -jar "$MONKEYBRAINS" \
            -o "bin/GMTWorldTime-${{ matrix.device }}.prg" \
            -f monkey.jungle \
            -d ${{ matrix.device }} \
            -y developer_key.der \
            -w 2>&1 || {
              echo "Build failed, showing detailed error..."
              java -jar "$MONKEYBRAINS" \
                -o "bin/GMTWorldTime-${{ matrix.device }}.prg" \
                -f monkey.jungle \
                -d ${{ matrix.device }} \
                -y developer_key.der
            }
          
          # Check if build succeeded
          if [ -f "bin/GMTWorldTime-${{ matrix.device }}.prg" ]; then
            echo "✅ Build successful for ${{ matrix.device }}"
            ls -la bin/
          else
            echo "❌ Build failed for ${{ matrix.device }}"
            exit 1
          fi

      - name: Install Screenshot Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb x11-utils scrot imagemagick libgtk-3-0 libwebkit2gtk-4.0-37 2>/dev/null || {
            sudo apt-get install -y xvfb x11-utils scrot imagemagick
          }

      - name: Take Simulator Screenshot
        continue-on-error: true  # Don't fail build if screenshot fails
        run: |
          mkdir -p screenshots
          
          SDK_PATH="$HOME/.Garmin/ConnectIQ/Sdks/sdk"
          SIMULATOR="$SDK_PATH/bin/simulator"
          MONKEYBRAINS=$(find $SDK_PATH -name "monkeybrains.jar" | head -1)
          SHELL_EXE="$SDK_PATH/bin/shell"
          
          # Check if simulator exists
          if [ ! -f "$SIMULATOR" ]; then
            echo "Simulator not found, skipping screenshot"
            echo "Available files in bin:"
            ls -la $SDK_PATH/bin/
            exit 0
          fi
          
          # Start virtual display
          echo "Starting Xvfb..."
          Xvfb :99 -screen 0 1024x768x24 &
          XVFB_PID=$!
          export DISPLAY=:99
          sleep 2
          
          # Start simulator
          echo "Starting simulator..."
          chmod +x "$SIMULATOR" 2>/dev/null || true
          "$SIMULATOR" &
          SIMULATOR_PID=$!
          sleep 5
          
          # Load the watchface
          echo "Loading watchface..."
          java -classpath "$MONKEYBRAINS" \
            com.garmin.monkeybrains.monkeydodeux.MonkeyDoDeux \
            -f "bin/GMTWorldTime-${{ matrix.device }}.prg" \
            -d ${{ matrix.device }} \
            -s "$SHELL_EXE" 2>&1 || echo "MonkeyDo may have failed"
          
          sleep 3
          
          # Capture screenshot
          echo "Capturing screenshot..."
          scrot "screenshots/${{ matrix.device }}.png" 2>/dev/null || {
            # Try alternative screenshot method
            import -window root "screenshots/${{ matrix.device }}.png" 2>/dev/null || echo "Screenshot capture failed"
          }
          
          # Cleanup
          kill $SIMULATOR_PID 2>/dev/null || true
          kill $XVFB_PID 2>/dev/null || true
          
          if [ -f "screenshots/${{ matrix.device }}.png" ]; then
            echo "✅ Screenshot captured for ${{ matrix.device }}"
            ls -la screenshots/
          else
            echo "⚠️ Screenshot not captured for ${{ matrix.device }}"
          fi

      - name: Upload PRG Artifact
        uses: actions/upload-artifact@v4
        with:
          name: GMTWorldTime-${{ matrix.device }}
          path: bin/GMTWorldTime-${{ matrix.device }}.prg
          retention-days: 30

      - name: Upload Screenshot
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: screenshot-${{ matrix.device }}
          path: screenshots/${{ matrix.device }}.png
          retention-days: 30
          if-no-files-found: ignore

  # Combine all builds into a single artifact
  combine-artifacts:
    needs: build
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Download all PRG artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-builds/
          pattern: GMTWorldTime-*
          merge-multiple: true

      - name: Download all screenshots
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          path: all-screenshots/
          pattern: screenshot-*
          merge-multiple: true

      - name: Create combined builds artifact
        uses: actions/upload-artifact@v4
        with:
          name: GMTWorldTime-all-devices
          path: all-builds/
          retention-days: 90

      - name: Create combined screenshots artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: all-screenshots
          path: all-screenshots/
          retention-days: 90
          if-no-files-found: ignore

      - name: Generate Build Summary
        run: |
          echo "## Build Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Device | PRG File |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|----------|" >> $GITHUB_STEP_SUMMARY
          for prg in all-builds/*.prg; do
            if [ -f "$prg" ]; then
              name=$(basename "$prg" .prg)
              size=$(ls -lh "$prg" | awk '{print $5}')
              echo "| ${name#GMTWorldTime-} | ✅ $size |" >> $GITHUB_STEP_SUMMARY
            fi
          done

  # Create a release on tags
  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: builds/
          pattern: GMTWorldTime-*
          merge-multiple: true

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: builds/*.prg
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
