# GitHub Actions workflow for building GMT World Time Watchface
# Builds for multiple Garmin Connect IQ devices with headless screenshot capture

name: Build Garmin Watchface

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:  # Allow manual trigger

# Sets permissions for GitHub Pages deployment
permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        device: 
          - fenix7
          - fenix5
          - venu
          - venu2
          - venu3
          - venu441mm
          - venu445mm
          - venux1
          - venusq2
          - fr965
          - fr255
          - fr245
          - vivoactive5
          - vivoactive4
          - epix2
      fail-fast: false  # Continue building other devices if one fails
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Cache Connect IQ SDK
        id: cache-sdk
        uses: actions/cache@v4
        with:
          path: |
            ~/.Garmin/ConnectIQ
          key: connectiq-sdk-7.3.1-${{ runner.os }}

      - name: Download and Setup Connect IQ SDK
        run: |
          # Create directories
          mkdir -p ~/.Garmin/ConnectIQ/Sdks/sdk
          mkdir -p ~/.Garmin/ConnectIQ/Devices
          
          # Download SDK bundle from our GitHub release (tar.gz for Linux compatibility)
          SDK_URL="https://github.com/berryk/Garmin-watchface/releases/download/sdk-v8.4.0-linux/connectiq-sdk-linux-bundle.tar.gz"
          
          echo "Downloading Connect IQ SDK bundle (154MB with 162 devices)..."
          wget -q "$SDK_URL" -O /tmp/sdk.tar.gz
          
          echo "Extracting SDK..."
          tar -xzf /tmp/sdk.tar.gz -C ~/.Garmin/ConnectIQ/Sdks/sdk
          rm /tmp/sdk.tar.gz
          
          # Move device files to correct location
          if [ -d ~/.Garmin/ConnectIQ/Sdks/sdk/Devices ]; then
            mv ~/.Garmin/ConnectIQ/Sdks/sdk/Devices/* ~/.Garmin/ConnectIQ/Devices/ 2>/dev/null || true
          fi
          
          # Set SDK path
          echo "CONNECTIQ_SDK=$HOME/.Garmin/ConnectIQ/Sdks/sdk" >> $GITHUB_ENV
          
          # Make scripts executable
          chmod +x ~/.Garmin/ConnectIQ/Sdks/sdk/bin/* 2>/dev/null || true
          
          echo "SDK installed to: $HOME/.Garmin/ConnectIQ/Sdks/sdk"
          ls -la ~/.Garmin/ConnectIQ/Sdks/sdk/bin/ | head -20
          echo "Device count: $(ls ~/.Garmin/ConnectIQ/Devices/ | wc -l)"

      - name: Generate Developer Key
        run: |
          # Generate a developer key for building (CI-only, not for distribution)
          openssl genrsa -out developer_key.pem 4096
          # Convert to DER format
          openssl pkcs8 -topk8 -inform PEM -outform DER -in developer_key.pem -out developer_key.der -nocrypt
          echo "Developer key generated"

      - name: Build for ${{ matrix.device }}
        run: |
          mkdir -p bin
          
          # Use the SDK we downloaded
          SDK_PATH="$HOME/.Garmin/ConnectIQ/Sdks/sdk"
          
          echo "Building for device: ${{ matrix.device }}"
          echo "SDK Path: $SDK_PATH"
          
          # Find monkeybrains.jar
          MONKEYBRAINS=$(find $SDK_PATH -name "monkeybrains.jar" | head -1)
          
          if [ -z "$MONKEYBRAINS" ]; then
            echo "ERROR: monkeybrains.jar not found in SDK"
            ls -la $SDK_PATH/
            exit 1
          fi
          
          echo "Using monkeybrains.jar: $MONKEYBRAINS"
          
          # Build the watchface
          java -jar "$MONKEYBRAINS" \
            -o "bin/GMTWorldTime-${{ matrix.device }}.prg" \
            -f monkey.jungle \
            -d ${{ matrix.device }} \
            -y developer_key.der \
            -w 2>&1 || {
              echo "Build failed, showing detailed error..."
              java -jar "$MONKEYBRAINS" \
                -o "bin/GMTWorldTime-${{ matrix.device }}.prg" \
                -f monkey.jungle \
                -d ${{ matrix.device }} \
                -y developer_key.der
            }
          
          # Check if build succeeded
          if [ -f "bin/GMTWorldTime-${{ matrix.device }}.prg" ]; then
            echo "✅ Build successful for ${{ matrix.device }}"
            ls -la bin/
          else
            echo "❌ Build failed for ${{ matrix.device }}"
            exit 1
          fi

      - name: Install Screenshot Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb x11-utils scrot imagemagick libgtk-3-0 libwebkit2gtk-4.0-37 libsecret-1-0 2>/dev/null || {
            sudo apt-get install -y xvfb x11-utils scrot imagemagick libsecret-1-0
          }

      - name: Take Simulator Screenshot
        continue-on-error: true  # Don't fail build if screenshot fails
        run: |
          mkdir -p screenshots
          
          SDK_PATH="$HOME/.Garmin/ConnectIQ/Sdks/sdk"
          SIMULATOR="$SDK_PATH/bin/simulator"
          MONKEYBRAINS=$(find $SDK_PATH -name "monkeybrains.jar" | head -1)
          SHELL_EXE="$SDK_PATH/bin/shell"
          
          # Check if simulator exists
          if [ ! -f "$SIMULATOR" ]; then
            echo "Simulator not found, skipping screenshot"
            echo "Available files in bin:"
            ls -la $SDK_PATH/bin/
            exit 0
          fi
          
          # Start virtual display
          echo "Starting Xvfb..."
          Xvfb :99 -screen 0 1024x768x24 &
          XVFB_PID=$!
          export DISPLAY=:99
          sleep 2
          
          # Start simulator
          echo "Starting simulator..."
          chmod +x "$SIMULATOR" 2>/dev/null || true
          "$SIMULATOR" &
          SIMULATOR_PID=$!
          sleep 5
          
          # Load the watchface
          echo "Loading watchface..."
          java -classpath "$MONKEYBRAINS" \
            com.garmin.monkeybrains.monkeydodeux.MonkeyDoDeux \
            -f "bin/GMTWorldTime-${{ matrix.device }}.prg" \
            -d ${{ matrix.device }} \
            -s "$SHELL_EXE" 2>&1 || echo "MonkeyDo may have failed"
          
          sleep 3
          
          # Capture screenshot
          echo "Capturing screenshot..."
          scrot "screenshots/${{ matrix.device }}.png" 2>/dev/null || {
            # Try alternative screenshot method
            import -window root "screenshots/${{ matrix.device }}.png" 2>/dev/null || echo "Screenshot capture failed"
          }
          
          # Cleanup
          kill $SIMULATOR_PID 2>/dev/null || true
          kill $XVFB_PID 2>/dev/null || true
          
          if [ -f "screenshots/${{ matrix.device }}.png" ]; then
            echo "✅ Screenshot captured for ${{ matrix.device }}"
            ls -la screenshots/
          else
            echo "⚠️ Screenshot not captured for ${{ matrix.device }}"
          fi

      - name: Upload PRG Artifact
        uses: actions/upload-artifact@v4
        with:
          name: GMTWorldTime-${{ matrix.device }}
          path: bin/GMTWorldTime-${{ matrix.device }}.prg
          retention-days: 30

      - name: Upload Screenshot
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: screenshot-${{ matrix.device }}
          path: screenshots/${{ matrix.device }}.png
          retention-days: 30
          if-no-files-found: ignore

  # Combine all builds into a single artifact
  combine-artifacts:
    needs: build
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Download all PRG artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-builds/
          pattern: GMTWorldTime-*
          merge-multiple: true

      - name: Download all screenshots
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          path: all-screenshots/
          pattern: screenshot-*
          merge-multiple: true

      - name: Create combined builds artifact
        uses: actions/upload-artifact@v4
        with:
          name: GMTWorldTime-all-devices
          path: all-builds/
          retention-days: 90

      - name: Create combined screenshots artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: all-screenshots
          path: all-screenshots/
          retention-days: 90
          if-no-files-found: ignore

      - name: Generate Build Summary
        run: |
          echo "## Build Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Device | PRG File |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|----------|" >> $GITHUB_STEP_SUMMARY
          for prg in all-builds/*.prg; do
            if [ -f "$prg" ]; then
              name=$(basename "$prg" .prg)
              size=$(ls -lh "$prg" | awk '{print $5}')
              echo "| ${name#GMTWorldTime-} | ✅ $size |" >> $GITHUB_STEP_SUMMARY
            fi
          done

  # Generate HTML build report with screenshots
  generate-report:
    needs: combine-artifacts
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all builds
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          path: all-builds/
          pattern: GMTWorldTime-*
          merge-multiple: true

      - name: Download all screenshots
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          path: all-screenshots/
          pattern: screenshot-*
          merge-multiple: true

      - name: Generate HTML Build Report
        run: |
          mkdir -p build-report
          
          # Get timestamp
          TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
          
          # Count devices
          TOTAL_DEVICES=0
          PASSED_DEVICES=0
          FAILED_DEVICES=0
          
          if [ -d "all-builds" ]; then
            TOTAL_DEVICES=$(find all-builds -name "*.prg" | wc -l)
            PASSED_DEVICES=$TOTAL_DEVICES
          fi
          
          # Start HTML
          cat > build-report/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <title>GMT World Time - Build Report</title>
              <style>
                  * { box-sizing: border-box; }
                  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 40px; background: #0a0a0a; color: #fff; }
                  h1 { color: #fff; font-weight: 300; margin-bottom: 10px; }
                  .timestamp { color: #666; margin-bottom: 30px; }
                  .summary { display: flex; gap: 30px; margin-bottom: 40px; }
                  .stat { background: #1a1a1a; padding: 20px 30px; border-radius: 12px; text-align: center; }
                  .stat-value { font-size: 42px; font-weight: 700; }
                  .stat-label { color: #888; font-size: 14px; margin-top: 5px; }
                  .pass { color: #4ade80; }
                  .fail { color: #f87171; }
                  .device-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
                  .device-card { background: #1a1a1a; border-radius: 12px; overflow: hidden; }
                  .device-header { padding: 15px 20px; border-bottom: 1px solid #333; }
                  .device-name { font-weight: 600; font-size: 15px; }
                  .device-info { color: #666; font-size: 11px; margin-top: 4px; }
                  .device-screenshot { width: 100%; aspect-ratio: 1; object-fit: contain; background: #000; }
                  .no-screenshot { width: 100%; aspect-ratio: 1; display: flex; align-items: center; justify-content: center; background: #0a0a0a; color: #444; font-size: 14px; }
                  .device-status { padding: 12px 20px; font-size: 12px; font-weight: 500; }
                  .status-pass { background: #052e16; color: #4ade80; }
                  .status-fail { background: #450a0a; color: #f87171; }
              </style>
          </head>
          <body>
              <h1>GMT World Time Watchface</h1>
              <p class="timestamp">Build Report - TIMESTAMP_PLACEHOLDER</p>
              
              <div class="summary">
                  <div class="stat">
                      <div class="stat-value">TOTAL_PLACEHOLDER</div>
                      <div class="stat-label">Devices Tested</div>
                  </div>
                  <div class="stat">
                      <div class="stat-value pass">PASSED_PLACEHOLDER</div>
                      <div class="stat-label">Build Passed</div>
                  </div>
                  <div class="stat">
                      <div class="stat-value fail">FAILED_PLACEHOLDER</div>
                      <div class="stat-label">Build Failed</div>
                  </div>
              </div>
              
              <div class="device-grid">
          EOF
          
          # Add device cards
          for prg in all-builds/*.prg; do
            if [ -f "$prg" ]; then
              device=$(basename "$prg" .prg | sed 's/GMTWorldTime-//')
              device_name=$(echo "$device" | sed 's/\([a-z]\)\([0-9]\)/\1 \2/g' | sed 's/\([a-z]\)\([A-Z]\)/\1 \2/g' | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) tolower(substr($i,2))} 1')
              prg_size=$(ls -lh "$prg" | awk '{print $5}')
              screenshot_file="all-screenshots/${device}.png"
              
              cat >> build-report/index.html << CARD
                  <div class="device-card">
                      <div class="device-header">
                          <div class="device-name">$device_name</div>
                          <div class="device-info">$device - $prg_size</div>
                      </div>
          CARD
              
              if [ -f "$screenshot_file" ]; then
                cp "$screenshot_file" "build-report/${device}.png"
                cat >> build-report/index.html << CARD
                      <img class='device-screenshot' src='${device}.png' alt='$device_name'>
          CARD
              else
                cat >> build-report/index.html << CARD
                      <div class='no-screenshot'>No screenshot available</div>
          CARD
              fi
              
              cat >> build-report/index.html << CARD
                      <div class="device-status status-pass">✅ Build Passed</div>
                  </div>
          CARD
            fi
          done
          
          # Close HTML
          cat >> build-report/index.html << 'EOF'
              </div>
          </body>
          </html>
          EOF
          
          # Replace placeholders
          sed -i "s/TIMESTAMP_PLACEHOLDER/$TIMESTAMP/g" build-report/index.html
          sed -i "s/TOTAL_PLACEHOLDER/$TOTAL_DEVICES/g" build-report/index.html
          sed -i "s/PASSED_PLACEHOLDER/$PASSED_DEVICES/g" build-report/index.html
          sed -i "s/FAILED_PLACEHOLDER/$FAILED_DEVICES/g" build-report/index.html
          
          echo "✅ Build report generated with $TOTAL_DEVICES devices"
          ls -la build-report/

      - name: Upload Build Report
        uses: actions/upload-artifact@v4
        with:
          name: build-report
          path: build-report/
          retention-days: 90

  # Deploy build report to GitHub Pages
  deploy-pages:
    needs: generate-report
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
    
    steps:
      - name: Download build report
        uses: actions/download-artifact@v4
        with:
          name: build-report
          path: ./public

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./public

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # Create a release on tags
  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: builds/
          pattern: GMTWorldTime-*
          merge-multiple: true

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: builds/*.prg
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
